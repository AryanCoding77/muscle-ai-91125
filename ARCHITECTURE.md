# ğŸ—ï¸ Subscription System Architecture

## System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MUSCLE AI MOBILE APP                      â”‚
â”‚                     (React Native)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ REST API / JWT Auth
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SUPABASE BACKEND                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              PostgreSQL Database                     â”‚   â”‚
â”‚  â”‚  â€¢ subscription_plans                                â”‚   â”‚
â”‚  â”‚  â€¢ user_subscriptions                                â”‚   â”‚
â”‚  â”‚  â€¢ payment_transactions                              â”‚   â”‚
â”‚  â”‚  â€¢ usage_tracking                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚           Edge Functions (Deno Runtime)              â”‚   â”‚
â”‚  â”‚  â€¢ create-subscription                               â”‚   â”‚
â”‚  â”‚  â€¢ verify-payment                                    â”‚   â”‚
â”‚  â”‚  â€¢ cancel-subscription                               â”‚   â”‚
â”‚  â”‚  â€¢ webhook-razorpay                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚                               â”‚
               â”‚ Razorpay API                  â”‚ Webhooks
               â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     RAZORPAY GATEWAY         â”‚  â”‚   RAZORPAY WEBHOOKS     â”‚
â”‚  â€¢ Payment Processing        â”‚  â”‚  â€¢ subscription.charged  â”‚
â”‚  â€¢ Subscription Management   â”‚  â”‚  â€¢ subscription.cancelledâ”‚
â”‚  â€¢ Customer Management       â”‚  â”‚  â€¢ payment.failed        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Component Interaction Flow

### 1. Subscription Creation

```
User                 App                Edge Function        Razorpay         Database
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚ Select Plan       â”‚                      â”‚                  â”‚               â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚ createSubscription() â”‚                  â”‚               â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚ Create Customer  â”‚               â”‚
 â”‚                    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
 â”‚                    â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚ Create Plan      â”‚               â”‚
 â”‚                    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
 â”‚                    â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚ Create Sub       â”‚               â”‚
 â”‚                    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
 â”‚                    â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚ Store Subscription               â”‚
 â”‚                    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚               â”‚
 â”‚                    â”‚  sub_id              â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚ Open Razorpay     â”‚                      â”‚                  â”‚               â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚ Enter Card & Pay  â”‚                      â”‚                  â”‚               â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚ Payment Success   â”‚                      â”‚                  â”‚               â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚               â”‚
 â”‚ (payment_id + signature)                â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚ verifyPayment()      â”‚                  â”‚               â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚ Verify Signature â”‚               â”‚
 â”‚                    â”‚                      â”‚ (HMAC SHA256)    â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚ Activate Sub + Record Payment    â”‚
 â”‚                    â”‚                      â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚               â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  verified=true       â”‚                  â”‚               â”‚
 â”‚                    â”‚                      â”‚                  â”‚               â”‚
 â”‚ âœ… Subscribed     â”‚                      â”‚                  â”‚               â”‚
```

---

### 2. Usage Tracking

```
User                 App                Database             Service
 â”‚                    â”‚                    â”‚                    â”‚
 â”‚ Start Analysis    â”‚                    â”‚                    â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
 â”‚                    â”‚                    â”‚                    â”‚
 â”‚                    â”‚ canUserAnalyze()   â”‚                    â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
 â”‚                    â”‚  can=true, remaining=4                  â”‚
 â”‚                    â”‚                    â”‚                    â”‚
 â”‚                    â”‚ performAnalysis()  â”‚                    â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                    â”‚                    â”‚                    â”‚
 â”‚                    â”‚ incrementUsage()   â”‚                    â”‚
 â”‚                    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
 â”‚                    â”‚  UPDATE counter+1  â”‚                    â”‚
 â”‚                    â”‚  INSERT tracking   â”‚                    â”‚
 â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚
 â”‚                    â”‚                    â”‚                    â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                    â”‚                    â”‚
 â”‚ Analysis Result   â”‚                    â”‚                    â”‚
 â”‚ (3 remaining)     â”‚                    â”‚                    â”‚
```

---

### 3. Webhook Processing (Monthly Renewal)

```
Razorpay          Webhook Handler      Database            User
    â”‚                   â”‚                  â”‚                  â”‚
    â”‚ Auto-charge      â”‚                  â”‚                  â”‚
    â”‚ (monthly)        â”‚                  â”‚                  â”‚
    â”‚                  â”‚                  â”‚                  â”‚
    â”‚ POST webhook     â”‚                  â”‚                  â”‚
    â”‚ subscription.    â”‚                  â”‚                  â”‚
    â”‚ charged          â”‚                  â”‚                  â”‚
    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚                  â”‚
    â”‚                  â”‚                  â”‚                  â”‚
    â”‚                  â”‚ Verify signature â”‚                  â”‚
    â”‚                  â”‚ (webhook secret) â”‚                  â”‚
    â”‚                  â”‚                  â”‚                  â”‚
    â”‚                  â”‚ UPDATE:          â”‚                  â”‚
    â”‚                  â”‚ - cycle dates    â”‚                  â”‚
    â”‚                  â”‚ - reset counter  â”‚                  â”‚
    â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
    â”‚                  â”‚                  â”‚                  â”‚
    â”‚                  â”‚ INSERT payment   â”‚                  â”‚
    â”‚                  â”‚ transaction      â”‚                  â”‚
    â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                  â”‚
    â”‚                  â”‚                  â”‚                  â”‚
    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                  â”‚                  â”‚
    â”‚ 200 OK           â”‚                  â”‚                  â”‚
    â”‚                  â”‚                  â”‚                  â”‚
    â”‚                  â”‚                  â”‚ Notify (email)   â”‚
    â”‚                  â”‚                  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
    â”‚                  â”‚                  â”‚                  â”‚
```

---

## Data Model

### Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  subscription_plans â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  id (PK)            â”‚
â”‚  plan_name          â”‚â—„â”€â”€â”€â”€â”
â”‚  plan_price_usd     â”‚     â”‚
â”‚  monthly_limit      â”‚     â”‚
â”‚  razorpay_plan_id   â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
                            â”‚
                            â”‚ FK: plan_id
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ user_subscriptions  â”‚     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚     â”‚
â”‚ id (PK)             â”‚     â”‚
â”‚ user_id (FK)        â”‚â”€â”€â”€â”€â”€â”˜
â”‚ plan_id (FK)        â”‚
â”‚ subscription_status â”‚
â”‚ razorpay_sub_id     â”‚
â”‚ cycle_start         â”‚
â”‚ cycle_end           â”‚
â”‚ analyses_used       â”‚â—„â”€â”€â”€â”€â”
â”‚ auto_renewal        â”‚     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
           â”‚                â”‚
           â”‚                â”‚
           â”‚ FK: subscription_id
           â”‚                â”‚
           â–¼                â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚ payment_transactionsâ”‚     â”‚
â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚     â”‚
â”‚ id (PK)             â”‚     â”‚
â”‚ user_id (FK)        â”‚     â”‚
â”‚ subscription_id (FK)â”‚â”€â”€â”€â”€â”€â”˜
â”‚ razorpay_payment_id â”‚
â”‚ amount_paid_usd     â”‚
â”‚ payment_status      â”‚
â”‚ transaction_date    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â”‚ FK: subscription_id
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   usage_tracking    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  id (PK)            â”‚
â”‚  user_id (FK)       â”‚
â”‚  subscription_id(FK)â”‚
â”‚  analysis_date      â”‚
â”‚  analysis_type      â”‚
â”‚  analysis_result_id â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Architecture

### Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     User     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Email/Password
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Auth   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â€¢ Verify creds  â”‚
â”‚  â€¢ Generate JWT  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ JWT Token
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API Requests   â”‚
â”‚  Authorization:  â”‚
â”‚  Bearer <JWT>    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RLS Policies    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  auth.uid() =    â”‚
â”‚  user_id         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Payment Security

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Payment    â”‚
â”‚   Details    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Transmitted via HTTPS
       â”‚ (Never stored in app)
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Razorpay SDK   â”‚
â”‚  (PCI Compliant) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ payment_id + signature
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Verify Signature â”‚
â”‚  HMAC SHA256     â”‚
â”‚  with secret     â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ If valid
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Activate Sub     â”‚
â”‚ in Database      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Scalability Considerations

### Current Architecture
- **Edge Functions**: Auto-scale with Supabase
- **Database**: Connection pooling via Supabase
- **Payments**: Handled by Razorpay infrastructure

### Performance Optimizations
1. **Database Indexes**: On frequently queried fields
2. **RLS Policies**: Efficient WHERE clauses
3. **Caching**: Client-side subscription state
4. **Pagination**: For payment history
5. **Lazy Loading**: Components loaded on demand

### Scaling Plan (Future)
```
Current (0-10K users):
â””â”€ Single Supabase project
   â””â”€ Default resources

Growth (10K-100K users):
â””â”€ Upgrade Supabase plan
   â””â”€ Read replicas
   â””â”€ Increased connections

Scale (100K+ users):
â””â”€ Consider:
   â””â”€ Redis caching layer
   â””â”€ CDN for static assets
   â””â”€ Dedicated edge function workers
   â””â”€ Database partitioning by user_id
```

---

## Monitoring & Observability

### Key Metrics Dashboard

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SUBSCRIPTION METRICS                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Total Active Subscriptions: 1,234                      â”‚
â”‚  â”œâ”€ Basic:  600 (48.6%)                                 â”‚
â”‚  â”œâ”€ Pro:    500 (40.5%)                                 â”‚
â”‚  â””â”€ VIP:    134 (10.9%)                                 â”‚
â”‚                                                          â”‚
â”‚  Monthly Recurring Revenue: $8,738                      â”‚
â”‚  Churn Rate: 5.2%                                       â”‚
â”‚  Average LTV: $156                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               PAYMENT METRICS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Success Rate: 97.8%                                    â”‚
â”‚  Failed Payments: 12 (last 24h)                         â”‚
â”‚  Avg Processing Time: 1.2s                              â”‚
â”‚  Total Transactions: 1,567                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               USAGE METRICS                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Total Analyses: 15,234                                 â”‚
â”‚  Avg per User: 12.3/month                               â”‚
â”‚  Peak Usage: Weekends (3pm-8pm)                         â”‚
â”‚  Low Usage Users: 234 (upgrade opportunity)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Alert Conditions

```yaml
alerts:
  - name: payment_failure_spike
    condition: failed_payments > 20 (1h)
    severity: high
    
  - name: webhook_delivery_failure
    condition: webhook_errors > 5 (10m)
    severity: critical
    
  - name: high_churn
    condition: cancellations > 50 (24h)
    severity: medium
    
  - name: database_slow
    condition: query_time > 500ms
    severity: high
```

---

## Technology Decisions

### Why Razorpay?
âœ… PCI-DSS compliant  
âœ… Recurring subscription support  
âœ… Multiple payment methods  
âœ… Automatic retry logic  
âœ… Strong webhook system  
âœ… Good documentation  

### Why Supabase Edge Functions?
âœ… Serverless (no infrastructure management)  
âœ… Auto-scaling  
âœ… Integrated with database  
âœ… Deno runtime (secure, fast)  
âœ… Built-in auth verification  
âœ… Low latency  

### Why PostgreSQL?
âœ… ACID compliance  
âœ… Row Level Security  
âœ… JSON support  
âœ… Triggers and functions  
âœ… Proven at scale  
âœ… Excellent with Supabase  

---

## Deployment Architecture

```
Development                 Staging                 Production
    â”‚                          â”‚                        â”‚
    â”‚ Test Keys                â”‚ Test Keys              â”‚ Live Keys
    â–¼                          â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Local   â”‚              â”‚ Staging â”‚              â”‚ Prod    â”‚
â”‚ Supabaseâ”‚â”€â”€deployâ”€â”€â”€â”€â”€>â”‚ Supabaseâ”‚â”€â”€promoteâ”€â”€â”€â”€>â”‚ Supabaseâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚                          â”‚                        â”‚
    â”‚ Test Cards               â”‚ Test Cards             â”‚ Real Cards
    â–¼                          â–¼                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Razorpay â”‚              â”‚Razorpay â”‚              â”‚Razorpay â”‚
â”‚Test Modeâ”‚              â”‚Test Modeâ”‚              â”‚Live Modeâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Backup & Recovery

### Database Backups
- **Automatic**: Daily via Supabase
- **Retention**: 30 days
- **Point-in-time recovery**: Available

### Disaster Recovery Plan
1. Database: Restore from latest backup
2. Edge Functions: Redeploy from git
3. Environment Secrets: Stored in secure vault
4. RPO (Recovery Point Objective): 24 hours
5. RTO (Recovery Time Objective): 1 hour

---

**Architecture Version**: 1.0.0  
**Last Updated**: 2025-10-01  
**Status**: Production Ready
